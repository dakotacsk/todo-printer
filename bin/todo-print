#!/bin/bash
# todo-print — Rongta ESC/POS: 2× title, points on next line (keeps '('), feed & cut
set -euo pipefail

PRINTER="RONGTA_RAW"                 # your RAW CUPS queue
MSG="${*:?Usage: todo-print \"Title (N pts)\"}"

# Feed length: ~3 lines ≈ 25–30 mm; adjust 4–6 to taste
FEED_LINES=5

# Accept explicit "\n" in CLI (e.g., todo-print $'Title\n(3 pts)')
MSG=$(echo -e "$MSG")
FIRST_LINE=$(echo "$MSG" | head -n1)
REST=$(echo "$MSG" | tail -n +2)

# --- Split at first '(' WITHOUT losing it ---
if [[ -z "$REST" && "$FIRST_LINE" == *"("* ]]; then
  TITLE="${FIRST_LINE%%\(*}"          # up to ( but not including
  POINTS="${FIRST_LINE#"$TITLE"}"     # starts with '(' exactly
else
  TITLE="$FIRST_LINE"
  POINTS="$REST"
fi

# Trim spaces (won't strip the '(')
TITLE="$(echo "$TITLE"  | sed 's/^[[:space:]]\+//; s/[[:space:]]\+$//')"
POINTS="$(echo "$POINTS" | sed 's/^[[:space:]]\+//; s/[[:space:]]\+$//')"

# --- ESC/POS controls ---
RESET=$'\x1B\x40'       # Initialize
CENTER=$'\x1B\x61\x01'  # Align center
LEFT=$'\x1B\x61\x00'
BIG2=$'\x1D\x21\x11'    # 2× width & 2× height (the size you liked)
NORMAL=$'\x1D\x21\x00'
CUT=$'\x1D\x56\x01'     # Full cut (feed then cut)

# Build feed as plain newlines (simple, reliable)
FEED=""
for ((i=0; i<FEED_LINES; i++)); do FEED+=$'\n'; done

# --- Emit one clean byte stream ---
{
  printf "%b" "$RESET$CENTER$BIG2"
  printf "%s\n" "$TITLE"

  if [[ -n "$POINTS" ]]; then
    printf "%b" "$NORMAL"
    printf "%s\n" "$POINTS"
  fi

  printf "%b" "$LEFT$FEED$CUT"
} | lp -d "$PRINTER" -o raw
